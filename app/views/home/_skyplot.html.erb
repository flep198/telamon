<script>

function updateSkyMap(date,redraw){

  //telescope coordinates
  lat=50.521497914;
  lon=6.876329828;

  //define arrays to store plot data
  tev_az=[];
  tev_alt=[];
  tev_name=[];
  extra_az=[];
  extra_alt=[];
  extra_name=[];
  follow_az=[];
  follow_alt=[];
  follow_name=[];
  look_az=[];
  look_alt=[];
  look_name=[];
  dropped_az=[];
  dropped_alt=[];
  dropped_name=[];
  

  //get source coordinates
  <% Source.all.order("j2000_name").each do |source| %>
    <% @cat=""%>
    <% source.source_categories.each do |scat| %>
      <% if ['Sample 1','Sample 2','Sample 3','Sample 4'].include? scat.name %>
        <% @cat="tev" %>
      <% elsif ['Neutrino Follow-Up'].include? scat.name %>
        <% @cat="follow" %>        
      <% elsif ['Neutrino Look-Up'].include? scat.name %>
        <% @cat="look" %>
      <% elsif ['Extra Neutrino-Source'].include? scat.name %>
        <% @cat="extra" %>
      <% end %>
      <% if ['Dropped'].include? scat.name %>
        <% @cat="dropped" %>
      <% end %>
    <% end %>

    <% unless source.ra.nil? ||  @cat=="" %>
      <% ra=source.ra.split(":",3) %>
      <% decl=source.decl.split(":",3) %>
      <% ra_deg=ra[0].to_f/24*360+ra[1].to_f/24/60*360+ra[2].to_f/24/60/60*360%>
      <% decl_deg=decl[0].to_f+decl[1].to_f/60+ra[2].to_f/60/60%>
      altaz=AltAz(<%=ra_deg%>,<%=decl_deg%>,lat,lon,date);
      <%=@cat%>_az.push(altaz[1]);
      <%=@cat%>_alt.push(altaz[0]);
      <%=@cat%>_name.push('<%=source.j2000_name%>');
    <% end %>
  <% end %>



  var trace1 = {
    x: tev_az,
    y: tev_alt,
    mode: 'markers+text',
    type: 'scatter',
    name: 'TeV Sample',
    text: tev_name,
    textposition: 'top center',
    textfont: {
      family:  'Times New Roman'
    },
    marker: { size: 12 }
  };

  var trace2 = {
    x: extra_az,
    y: extra_alt,
    mode: 'markers+text',
    type: 'scatter',
    name: 'Extra Neutrino Sources',
    text: extra_name,
    textfont : {
      family:'Times New Roman'
    },
    textposition: 'bottom center',
    marker: { size: 12 }
  };

  var trace3 = {
    x: follow_az,
    y: follow_alt,
    mode: 'markers+text',
    type: 'scatter',
    name: 'Neutrino Follow Up',
    text: extra_name,
    textfont : {
      family:'Times New Roman'
    },
    textposition: 'bottom center',
    marker: { size: 12 }
  };

  var trace4 = {
    x: look_az,
    y: look_alt,
    mode: 'markers+text',
    type: 'scatter',
    name: 'Neutrino Look Up',
    text: look_name,
    textfont : {
      family:'Times New Roman'
    },
    textposition: 'bottom center',
    marker: { size: 12 }
  };

    var trace5 = {
    x: dropped_az,
    y: dropped_alt,
    mode: 'markers+text',
    type: 'scatter',
    name: 'Dropped',
    text: dropped_name,
    textfont : {
      family:'Times New Roman'
    },
    textposition: 'bottom center',
    marker: { size: 12 }
  };

  var data = [ trace1, trace2 , trace3, trace4, trace5 ];

  var layout = {
    xaxis: {
      range: [ 0, 360 ]
    },
    yaxis: {
      range: [0, 90]
    },
    legend: {
      y: 0.5,
      yref: 'paper',
      font: {
        family: 'Arial, sans-serif',
        size: 20,
        color: 'grey',
      }
    },
    title:'Effelsberg Skyplot'
  };

  if (redraw){
  Plotly.newPlot('skyplot', data, layout);
  } else {
  Plotly.redraw('skyplot');
  }
}

updateSkyMap(new Date(),true);

setInterval(function(){updateSkyMap(new Date(),false)},10000);

</script>