<!--creates interactive filters-->
<script>
function download_table_as_csv(table_id, separator = ',') {
    // Select rows from table_id
    var rows = document.querySelectorAll('table#' + table_id + ' tr');
    // Construct csv
    var csv = [];
    for (var i = 0; i < rows.length; i++) {
        var row = [], cols = rows[i].querySelectorAll('td, th');
        for (var j = 0; j < cols.length; j++) {
            // Clean innertext to remove multiple spaces and jumpline (break csv)
            var data = cols[j].innerText.replace(/(\r\n|\n|\r)/gm, '').replace(/(\s\s)/gm, ' ')
            // Escape double-quote with double-double-quote (see https://stackoverflow.com/questions/17808511/properly-escape-a-double-quote-in-csv)
            data = data.replace(/"/g, '""');
            // Push escaped string
            row.push('"' + data + '"');
        }
        csv.push(row.join(separator));
    }
    var csv_string = csv.join('\n');
    // Download it
    var filename = table_id + '.csv';
    var link = document.createElement('a');
    link.style.display = 'none';
    link.setAttribute('target', '_blank');
    link.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv_string));
    link.setAttribute('download', filename);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

window.onload=function(){

    if(!!document.getElementById("export_button")){
        var table_name = document.getElementById("export_button").dataset.table;
        document.getElementById("export_button").addEventListener("click", function(){download_table_as_csv(table_name)});
    }



    //make tables sortable
    const getCellValue = (tr, idx) => tr.children[idx].innerText || tr.children[idx].textContent;

    const comparer = (idx, asc) => (a, b) => ((v1, v2) => 
        v1 !== '' && v2 !== '' && !isNaN(v1) && !isNaN(v2) ? v1 - v2 : v1.toString().localeCompare(v2)
        )(getCellValue(asc ? a : b, idx), getCellValue(asc ? b : a, idx));

    document.querySelectorAll('th').forEach(th => th.addEventListener('click', (() => {
        const table = th.closest('table');
        const tbody = table.querySelector('tbody');
        Array.from(tbody.querySelectorAll('tr'))
            .sort(comparer(Array.from(th.parentNode.children).indexOf(th), this.asc = !this.asc))
            .forEach(tr => tbody.appendChild(tr) );
    })));

    
    //checkbox for source table

    var checkboxSample1 = document.querySelector("input[name=Sample1]");
    var checkboxSample2 = document.querySelector("input[name=Sample2]");
    var checkboxBadWeather = document.querySelector("input[name=BadWeather]");
    var checkboxCalibrator = document.querySelector("input[name=Calibrator]");
    var checkboxDropped = document.querySelector("input[name=excludeDropped]");
    var checkboxNeutrino = document.querySelector("input[name=Neutrino]");

    //old table filter function
    function CategoryFilterTable(checkbox,CategoryName){
        var table, tr, td, i, txtValue;
        table = document.getElementById("sourceTable");
        tr = table.getElementsByTagName("tr");
        
        for (i=0; i<tr.length; i++){
            td = tr[i].getElementsByTagName("td")[3];
            if (td) {
                txtValue = td.textContent || td.innerText;
                    if (!checkbox.checked && txtValue.includes(CategoryName)){
                        tr[i].style.display="none";
                    } else {
                        if(txtValue.includes(CategoryName)){
                            tr[i].style.display=""; 
                        }                        
                    };          
            };
        };
    };

    //this function updates the table according to the set filters
    function updateTable(){
        var sample1 = checkboxSample1.checked;
        var sample2 = checkboxSample2.checked;
        var badweather = checkboxBadWeather.checked;
        var calibrator = checkboxCalibrator.checked;
        var dropped = checkboxDropped.checked;
        var neutrino = checkboxNeutrino.checked;

        var table, tr, td, i, txtValue;
        table = document.getElementById("sourceTable");
        tr = table.getElementsByTagName("tr");

        for (i=1;i<tr.length;i++){
            td = tr[i].getElementsByTagName("td");
            var j2000_name = td[0];
            var alt_name = td[1];
            var source_class = td[2];
            var category = td[3];
            var aver_20mm = td[4];
            var aver_14mm = td[5];
            var aver_7mm = td[6];
            var redshift = td[7];
            var ra = td[8];
            var dec = td[9];

            var show = false;
            //put filter options here to determine show boolean
            if (category){
                var category_txt = category.textContent || category.innerText;
                if (sample1 && category_txt.includes("Sample 1")){
                    var show=true;
                };
                if (sample2 && category_txt.includes("Sample 2")){
                    var show=true;
                };
                if (badweather && category_txt.includes("Bad Weather")){
                    var show=true;
                };
                if (calibrator && category_txt.includes("Calibrator")){
                    var show=true;
                };
            };

            

            if (show){
                tr[i].style.display=""; //show entry
            } else {
                tr[i].style.display="none"; //hide entry                
            };
        };

    };
    
    checkboxSample1.addEventListener('change', function(){updateTable()});
    checkboxSample2.addEventListener('change', function(){CategoryFilterTable(this,"Sample 2")});
    checkboxBadWeather.addEventListener('change', function(){CategoryFilterTable(this,"Bad Weather")});
    checkboxCalibrator.addEventListener('change', function(){CategoryFilterTable(this,"Calibrator")});
    checkboxDropped.addEventListener('change', function(){CategoryFilterTable(this,"Dropped")});
    checkboxNeutrino.addEventListener('change', function(){CategoryFilterTable(this,"Neutrino")});

} 

</script>